# AWS Networking Mapper

This package provides bidirectional mapping between domain networking resources and AWS-specific networking models, supporting both **input models** (for creation/configuration) and **output models** (for responses with AWS-generated identifiers).

## Purpose

The mapper layer enables:
- **Domain → AWS Input**: Convert cloud-agnostic domain models to AWS-specific input models
- **AWS Output → Domain**: Convert AWS output models (with IDs/ARNs) back to domain models
- **Separation of Concerns**: Keeps domain and cloud layers decoupled
- **ID/ARN Population**: Maps AWS-generated identifiers to domain models

## Input vs Output Models

### Input Models (Resources)
- **Purpose**: Configuration data for creating/updating resources
- **Location**: `internal/cloud/aws/models/networking/`
- **Fields**: Configuration fields only (Name, CIDR, Region, etc.)
- **No AWS IDs**: No `ID` or `ARN` fields (these are generated by AWS)
- **Usage**: Used when creating or updating resources

### Output Models
- **Purpose**: Response data after resource creation/retrieval
- **Location**: `internal/cloud/aws/models/networking/outputs/`
- **Fields**: Configuration fields + AWS-generated metadata
- **AWS Identifiers**: Contains `ID`, `ARN`, `State`, `CreationTime`, etc.
- **Usage**: Returned by AWS services after operations

### Key Differences

| Aspect | Input Model | Output Model |
|--------|------------|--------------|
| **ID Field** | ❌ Not present | ✅ AWS-generated ID (e.g., `vpc-0a1b2c3d4e5f6g7h8`) |
| **ARN Field** | ❌ Not present | ✅ AWS ARN (e.g., `arn:aws:ec2:us-east-1:123456789012:vpc/...`) |
| **State** | ❌ Not present | ✅ Resource state (`available`, `pending`, etc.) |
| **CreationTime** | ❌ Not present | ✅ Timestamp when resource was created |
| **Purpose** | Configuration | Response/Result |
| **When Used** | Before creation | After creation/retrieval |

## Mappers

### VPC Mapper
- `ToDomainVPC()` - AWS VPC input → Domain VPC (backward compatibility)
- `ToDomainVPCFromOutput()` - AWS VPC output → Domain VPC (with ID/ARN)
- `FromDomainVPC()` - Domain VPC → AWS VPC input

### Subnet Mapper
- `ToDomainSubnet()` - AWS Subnet input → Domain Subnet (backward compatibility)
- `ToDomainSubnetFromOutput()` - AWS Subnet output → Domain Subnet (with ID/ARN)
- `FromDomainSubnet()` - Domain Subnet → AWS Subnet input

### Internet Gateway Mapper
- `ToDomainInternetGateway()` - AWS IGW input → Domain IGW (backward compatibility)
- `ToDomainInternetGatewayFromOutput()` - AWS IGW output → Domain IGW (with ID/ARN)
- `FromDomainInternetGateway()` - Domain IGW → AWS IGW input

### Route Table Mapper
- `ToDomainRouteTable()` - AWS Route Table input → Domain Route Table (backward compatibility)
- `ToDomainRouteTableFromOutput()` - AWS Route Table output → Domain Route Table (with ID/ARN, associations)
- `FromDomainRouteTable()` - Domain Route Table → AWS Route Table input

### Security Group Mapper
- `ToDomainSecurityGroup()` - AWS SG input → Domain SG (backward compatibility)
- `ToDomainSecurityGroupFromOutput()` - AWS SG output → Domain SG (with ID/ARN)
- `FromDomainSecurityGroup()` - Domain SG → AWS SG input

### NAT Gateway Mapper
- `ToDomainNATGateway()` - AWS NAT input → Domain NAT (backward compatibility)
- `ToDomainNATGatewayFromOutput()` - AWS NAT output → Domain NAT (with ID/ARN)
- `FromDomainNATGateway()` - Domain NAT → AWS NAT input

## Usage Examples

### Creating a Resource (Input Model Flow)

```go
import (
    domainnetworking "github.com/mo7amedgom3a/arch-visualizer/backend/internal/domain/resource/networking"
    awsnetworking "github.com/mo7amedgom3a/arch-visualizer/backend/internal/cloud/aws/models/networking"
    awsmapper "github.com/mo7amedgom3a/arch-visualizer/backend/internal/cloud/aws/mapper/networking"
)

// Domain VPC (cloud-agnostic, no ID/ARN yet)
domainVPC := &domainnetworking.VPC{
    Name:   "my-vpc",
    Region: "us-east-1",
    CIDR:   "10.0.0.0/16",
    EnableDNS: true,
}

// Convert to AWS VPC input model (for creation)
awsVPCInput := awsmapper.FromDomainVPC(domainVPC)
// awsVPCInput has no ID or ARN - these will be generated by AWS
```

### Handling Resource Response (Output Model Flow)

```go
import (
    awsoutputs "github.com/mo7amedgom3a/arch-visualizer/backend/internal/cloud/aws/models/networking/outputs"
)

// AWS service returns output model (after creation)
awsVPCOutput := &awsoutputs.VPCOutput{
    ID:     "vpc-0a1b2c3d4e5f6g7h8",  // AWS-generated
    ARN:    "arn:aws:ec2:us-east-1:123456789012:vpc/vpc-0a1b2c3d4e5f6g7h8",
    Name:   "my-vpc",
    Region: "us-east-1",
    CIDR:   "10.0.0.0/16",
    State:  "available",
    // ... other fields
}

// Convert output to domain model (with ID/ARN populated)
domainVPCWithID := awsmapper.ToDomainVPCFromOutput(awsVPCOutput)
// domainVPCWithID.ID = "vpc-0a1b2c3d4e5f6g7h8"
// domainVPCWithID.ARN = "arn:aws:ec2:..."
```

### Complete Flow Example

```go
// 1. Start with domain model (no ID/ARN)
domainVPC := &domainnetworking.VPC{...}

// 2. Convert to AWS input model
awsVPCInput := awsmapper.FromDomainVPC(domainVPC)

// 3. Create via AWS service (returns output model)
awsVPCOutput, err := awsService.CreateVPC(ctx, awsVPCInput)

// 4. Convert output back to domain (with ID/ARN)
domainVPCWithID := awsmapper.ToDomainVPCFromOutput(awsVPCOutput)
// Now domainVPCWithID has ID and ARN populated!
```

## Mapping Rules

### VPC
- Domain `EnableDNS` → AWS `EnableDNSSupport`
- Domain `EnableDNSHostnames` → AWS `EnableDNSHostnames`
- AWS adds default `InstanceTenancy` and `Tags`

### Subnet
- Domain `IsPublic` → AWS `MapPublicIPOnLaunch`
- Domain `AvailabilityZone` → AWS `AvailabilityZone` (required)
- AWS adds default `Tags`

### Route Table
- Domain route `TargetType` → AWS route target fields (gateway_id, nat_gateway_id, etc.)
- AWS supports multiple target types, domain uses single target per route

### Security Group
- Domain `SourceGroupIDs` (list) → AWS `SourceSecurityGroupID` (single)
- AWS limitation: only one source security group per rule

## Output Model Mapping Details

### ID and ARN Handling

When mapping from output models to domain models:
- **ID**: Always copied from output model to domain model
- **ARN**: Copied if present, set to `nil` if empty string
- **Empty ARN**: If output model has empty ARN string, domain model gets `nil` (not empty string)

Example:
```go
// Output model with ARN
output := &awsoutputs.VPCOutput{
    ID:  "vpc-123",
    ARN: "arn:aws:ec2:...",
}
domain := ToDomainVPCFromOutput(output)
// domain.ARN = &"arn:aws:ec2:..." (pointer to string)

// Output model with empty ARN
output := &awsoutputs.VPCOutput{
    ID:  "vpc-123",
    ARN: "",  // empty string
}
domain := ToDomainVPCFromOutput(output)
// domain.ARN = nil (not empty string)
```

### Route Table Associations

Route table output models include associations that are mapped to domain model's `Subnets` field:

```go
// Output model has associations
output := &awsoutputs.RouteTableOutput{
    Associations: []RouteTableAssociation{
        {SubnetID: "subnet-1"},
        {SubnetID: "subnet-2"},
    },
}

// Domain model gets subnet IDs
domain := ToDomainRouteTableFromOutput(output)
// domain.Subnets = []string{"subnet-1", "subnet-2"}
```

## Design Notes

- **Null Safety**: All mappers handle nil inputs gracefully
- **Default Values**: AWS mappers add provider-specific defaults (tags, tenancy)
- **Field Mapping**: Some fields map 1:1, others require transformation
- **Validation**: Mappers don't validate - validation happens in model `Validate()` methods
- **Output Models**: Always use `*FromOutput` functions when mapping AWS service responses
- **Backward Compatibility**: Original `ToDomain*` functions still exist for input models