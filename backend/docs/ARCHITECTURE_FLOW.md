# Architecture Flow: JSON IR to Terraform Code Generation

This document describes the complete data flow and layer interactions from frontend diagram JSON to generated Terraform files.

## High-Level Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              TERRAFORM CODEGEN PIPELINE                                  │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐          │
│  │  Frontend    │    │   Diagram    │    │   Domain     │    │     IaC      │          │
│  │   JSON IR    │───▶│    Layer     │───▶│    Layer     │───▶│    Layer     │──▶ .tf  │
│  │              │    │              │    │              │    │              │          │
│  └──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘          │
│                                                                                          │
│       INPUT              PARSE &            TRANSFORM &         GENERATE &               │
│                         VALIDATE            MAP TYPES           RENDER HCL               │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

## Detailed Layer Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                           COMPLETE SYSTEM ARCHITECTURE                                       │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                    1. INPUT LAYER (Frontend JSON IR)                                 │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                                      │   │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │   │
│  │   │  Project-Wrapped JSON:                                                                       │   │   │
│  │   │  {                                                                                           │   │   │
│  │   │    "cloud-canvas-project-xxx": {                                                             │   │   │
│  │   │      "nodes": [ IRNode, ... ],                                                               │   │   │
│  │   │      "edges": [ IREdge, ... ],                                                               │   │   │
│  │   │      "variables": [],                                                                        │   │   │
│  │   │      "timestamp": 1234567890                                                                 │   │   │
│  │   │    }                                                                                         │   │   │
│  │   │  }                                                                                           │   │   │
│  │   └─────────────────────────────────────────────────────────────────────────────────────────────┘   │   │
│  │                                              │                                                       │   │
│  │                                              ▼                                                       │   │
│  │                                  extractDiagramFromProjectJSON()                                     │   │
│  │                                              │                                                       │   │
│  └──────────────────────────────────────────────┼──────────────────────────────────────────────────────┘   │
│                                                 │                                                           │
│                                                 ▼                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                    2. DIAGRAM LAYER (Parse & Validate)                               │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                                      │   │
│  │   ┌──────────────────────┐     ┌──────────────────────┐     ┌──────────────────────┐               │   │
│  │   │   parser.ParseIR     │────▶│  parser.NormalizeToGraph  │────▶│  validator.Validate    │         │   │
│  │   │     Diagram()        │     │        ()            │     │        ()            │               │   │
│  │   └──────────────────────┘     └──────────────────────┘     └──────────────────────┘               │   │
│  │            │                            │                            │                              │   │
│  │            ▼                            ▼                            ▼                              │   │
│  │   ┌──────────────────────┐     ┌──────────────────────┐     ┌──────────────────────┐               │   │
│  │   │     IRDiagram        │     │    DiagramGraph      │     │  ValidationResult    │               │   │
│  │   │  ┌────────────────┐  │     │  ┌────────────────┐  │     │  ┌────────────────┐  │               │   │
│  │   │  │ Nodes []IRNode │  │     │  │ Nodes map[id]  │  │     │  │ Valid bool     │  │               │   │
│  │   │  │ Edges []IREdge │  │     │  │    *Node       │  │     │  │ Errors []      │  │               │   │
│  │   │  │ Variables []   │  │     │  │ Edges []*Edge  │  │     │  │ Warnings []    │  │               │   │
│  │   │  │ Timestamp int  │  │     │  └────────────────┘  │     │  └────────────────┘  │               │   │
│  │   │  └────────────────┘  │     └──────────────────────┘     └──────────────────────┘               │   │
│  │   └──────────────────────┘                                                                          │   │
│  │                                                                                                      │   │
│  │   Validations Performed:                                                                             │   │
│  │   • Missing parent references    • Containment cycles       • Edge references                       │   │
│  │   • Dependency self-loops        • Resource types           • Region node presence                  │   │
│  │   • Config schema validation     • CIDR validity/overlaps   • Containment type rules                │   │
│  │                                                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                 │                                                           │
│                                                 ▼                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                    3. DOMAIN LAYER (Cloud-Agnostic Core)                             │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                                      │   │
│  │   ┌────────────────────────────────────────────────────────────────────────────────────────────┐    │   │
│  │   │                          MapDiagramToArchitecture(diagramGraph, provider)                   │    │   │
│  │   │                                            │                                                │    │   │
│  │   │                     ┌──────────────────────┼──────────────────────┐                        │    │   │
│  │   │                     ▼                      ▼                      ▼                        │    │   │
│  │   │           ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐              │    │   │
│  │   │           │  GetGenerator   │    │ GetResourceType │    │  Default        │              │    │   │
│  │   │           │   (provider)    │    │    Mapper       │    │  Implementation │              │    │   │
│  │   │           └────────┬────────┘    └────────┬────────┘    └────────┬────────┘              │    │   │
│  │   │                    │                      │                      │                        │    │   │
│  │   │                    └──────────────────────┴──────────────────────┘                        │    │   │
│  │   │                                           │                                               │    │   │
│  │   │                                           ▼                                               │    │   │
│  │   │                              ┌─────────────────────────┐                                  │    │   │
│  │   │                              │      Architecture       │                                  │    │   │
│  │   │                              │  ┌───────────────────┐  │                                  │    │   │
│  │   │                              │  │ Resources []*     │  │                                  │    │   │
│  │   │                              │  │   Resource        │  │                                  │    │   │
│  │   │                              │  │ Region string     │  │                                  │    │   │
│  │   │                              │  │ Provider          │  │                                  │    │   │
│  │   │                              │  │ Containments map  │  │                                  │    │   │
│  │   │                              │  │ Dependencies map  │  │                                  │    │   │
│  │   │                              │  └───────────────────┘  │                                  │    │   │
│  │   │                              └─────────────────────────┘                                  │    │   │
│  │   └────────────────────────────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                                                      │   │
│  │   ┌────────────────────────────────────────────────────────────────────────────────────────────┐    │   │
│  │   │                                   Domain Models                                             │    │   │
│  │   │                                                                                             │    │   │
│  │   │   ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐           │    │   │
│  │   │   │      Resource       │    │    ResourceType     │    │   CloudProvider     │           │    │   │
│  │   │   │  ┌───────────────┐  │    │  ┌───────────────┐  │    │  ┌───────────────┐  │           │    │   │
│  │   │   │  │ ID string     │  │    │  │ ID string     │  │    │  │ AWS           │  │           │    │   │
│  │   │   │  │ Name string   │  │    │  │ Name string   │  │    │  │ Azure         │  │           │    │   │
│  │   │   │  │ Type          │  │    │  │ Category      │  │    │  │ GCP           │  │           │    │   │
│  │   │   │  │ Provider      │  │    │  │ Kind string   │  │    │  └───────────────┘  │           │    │   │
│  │   │   │  │ Region        │  │    │  │ IsRegional    │  │    └─────────────────────┘           │    │   │
│  │   │   │  │ ParentID *    │  │    │  │ IsGlobal      │  │                                      │    │   │
│  │   │   │  │ DependsOn []  │  │    │  └───────────────┘  │                                      │    │   │
│  │   │   │  │ Metadata map  │  │    └─────────────────────┘                                      │    │   │
│  │   │   │  └───────────────┘  │                                                                 │    │   │
│  │   │   └─────────────────────┘                                                                 │    │   │
│  │   └────────────────────────────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                 │                                                           │
│                                                 ▼                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                    4. CLOUD ADAPTER LAYER (Provider-Specific)                        │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                                      │   │
│  │   ┌────────────────────────────────────────────────────────────────────────────────────────────┐    │   │
│  │   │                              AWS Architecture Package                                       │    │   │
│  │   │                                                                                             │    │   │
│  │   │   ┌─────────────────────────┐         ┌─────────────────────────┐                          │    │   │
│  │   │   │  AWSArchitectureGenerator │         │  AWSResourceTypeMapper  │                          │    │   │
│  │   │   │  ┌───────────────────┐   │         │  ┌───────────────────┐   │                          │    │   │
│  │   │   │  │ Generate()        │   │         │  │ MapIRTypeToResource│   │                          │    │   │
│  │   │   │  │ - Extract region  │   │         │  │   Type()          │   │                          │    │   │
│  │   │   │  │ - Build node map  │   │         │  │ MapResourceNameTo │   │                          │    │   │
│  │   │   │  │ - Create resources│   │         │  │   ResourceType()  │   │                          │    │   │
│  │   │   │  │ - Build relations │   │         │  └───────────────────┘   │                          │    │   │
│  │   │   │  └───────────────────┘   │         └─────────────────────────┘                          │    │   │
│  │   │   └─────────────────────────┘                                                               │    │   │
│  │   │                                                                                             │    │   │
│  │   │   IR Type Mapping:                                                                          │    │   │
│  │   │   "vpc" ──────────────▶ VPC ──────────────▶ ResourceType{ID:"vpc", Name:"VPC", ...}        │    │   │
│  │   │   "ec2" ──────────────▶ EC2 ──────────────▶ ResourceType{ID:"ec2", Name:"EC2", ...}        │    │   │
│  │   │   "subnet" ───────────▶ Subnet ───────────▶ ResourceType{ID:"subnet", Name:"Subnet", ...}  │    │   │
│  │   │   "security-group" ───▶ SecurityGroup ────▶ ResourceType{ID:"sg", Name:"SecurityGroup"...} │    │   │
│  │   │                                                                                             │    │   │
│  │   └────────────────────────────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                 │                                                           │
│                                                 ▼                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                    5. RULES & VALIDATION LAYER                                       │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                                      │   │
│  │   ┌────────────────────────────────────────────────────────────────────────────────────────────┐    │   │
│  │   │                              Domain Validation                                              │    │   │
│  │   │                                                                                             │    │   │
│  │   │   arch.Validate() ──▶ Check parent existence, basic constraints                            │    │   │
│  │   │                                                                                             │    │   │
│  │   └────────────────────────────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                                                      │   │
│  │   ┌────────────────────────────────────────────────────────────────────────────────────────────┐    │   │
│  │   │                              AWS Rules Service                                              │    │   │
│  │   │                                                                                             │    │   │
│  │   │   ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐           │    │   │
│  │   │   │   AWSRuleService    │    │   AWSRuleFactory    │    │   RuleEvaluator     │           │    │   │
│  │   │   │  ┌───────────────┐  │    │  ┌───────────────┐  │    │  ┌───────────────┐  │           │    │   │
│  │   │   │  │ LoadRulesWithDefaults │  │ CreateRule()  │  │    │  │ Evaluate()    │  │           │    │   │
│  │   │   │  │ ValidateArchitecture  │  │               │  │    │  │               │  │           │    │   │
│  │   │   │  │ ValidateResource │  │    │               │  │    │  │               │  │           │    │   │
│  │   │   │  └───────────────┘  │    │  └───────────────┘  │    │  └───────────────┘  │           │    │   │
│  │   │   └─────────────────────┘    └─────────────────────┘    └─────────────────────┘           │    │   │
│  │   │                                                                                             │    │   │
│  │   │   Rules Applied:                                                                            │    │   │
│  │   │   • Default networking rules (CIDR constraints, subnet limits)                             │    │   │
│  │   │   • Resource-specific constraints (EC2 instance types, etc.)                               │    │   │
│  │   │   • Cross-resource validation (security group references, etc.)                            │    │   │
│  │   │                                                                                             │    │   │
│  │   └────────────────────────────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                 │                                                           │
│                                                 ▼                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                    6. GRAPH & TOPOLOGICAL SORT LAYER                                 │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                                      │   │
│  │   ┌────────────────────────────────────────────────────────────────────────────────────────────┐    │   │
│  │   │                              Domain Graph Operations                                        │    │   │
│  │   │                                                                                             │    │   │
│  │   │   ┌─────────────────────────┐         ┌─────────────────────────┐                          │    │   │
│  │   │   │    architecture.Graph    │         │   TopologicalSort       │                          │    │   │
│  │   │   │  ┌───────────────────┐   │         │  ┌───────────────────┐   │                          │    │   │
│  │   │   │  │ GetResource()     │   │         │  │ Kahn's Algorithm  │   │                          │    │   │
│  │   │   │  │ GetChildren()     │   │         │  │ - Build adjacency │   │                          │    │   │
│  │   │   │  │ GetParent()       │   │         │  │ - Process in-degree│   │                          │    │   │
│  │   │   │  │ GetDependencies() │   │         │  │ - Detect cycles   │   │                          │    │   │
│  │   │   │  │ GetRootResources()│   │         │  │ - Return levels   │   │                          │    │   │
│  │   │   │  └───────────────────┘   │         │  └───────────────────┘   │                          │    │   │
│  │   │   └─────────────────────────┘         └─────────────────────────┘                          │    │   │
│  │   │                                                                                             │    │   │
│  │   │   Dependency Resolution:                                                                    │    │   │
│  │   │   • Explicit dependencies (DependsOn field)                                                │    │   │
│  │   │   • Containment dependencies (children depend on parents)                                  │    │   │
│  │   │   • ParentID relationships                                                                 │    │   │
│  │   │                                                                                             │    │   │
│  │   │   Example Sort Order:                                                                       │    │   │
│  │   │   Level 0: VPC (no dependencies)                                                           │    │   │
│  │   │   Level 1: Subnet, SecurityGroup, InternetGateway (depend on VPC)                          │    │   │
│  │   │   Level 2: EC2, NATGateway, RouteTable (depend on Subnet/SG)                               │    │   │
│  │   │                                                                                             │    │   │
│  │   └────────────────────────────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                 │                                                           │
│                                                 ▼                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                    7. IAC TERRAFORM LAYER (Code Generation)                          │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                                      │   │
│  │   ┌────────────────────────────────────────────────────────────────────────────────────────────┐    │   │
│  │   │                              Terraform Engine Pipeline                                      │    │   │
│  │   │                                                                                             │    │   │
│  │   │   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐   │    │   │
│  │   │   │ MapperRegistry  │───▶│  tfgen.Engine   │───▶│  writer.Render  │───▶│  iac.Output │   │    │   │
│  │   │   │                 │    │                 │    │    MainTF()     │    │             │   │    │   │
│  │   │   └─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────┘   │    │   │
│  │   │          │                        │                      │                    │          │    │   │
│  │   │          ▼                        ▼                      ▼                    ▼          │    │   │
│  │   │   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐   │    │   │
│  │   │   │   AWSMapper     │    │ TerraformBlock  │    │   hclwrite      │    │ GeneratedFile│   │    │   │
│  │   │   │  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌───────────┐  │    │ ┌─────────┐ │   │    │   │
│  │   │   │  │ mapVPC()  │  │    │  │ Kind      │  │    │  │ NewEmpty  │  │    │ │ Path    │ │   │    │   │
│  │   │   │  │ mapSubnet()│  │    │  │ Labels    │  │    │  │   File()  │  │    │ │ Content │ │   │    │   │
│  │   │   │  │ mapEC2()  │  │    │  │ Attributes│  │    │  │ Append    │  │    │ │ Type    │ │   │    │   │
│  │   │   │  │ mapSG()   │  │    │  └───────────┘  │    │  │   Block() │  │    │ └─────────┘ │   │    │   │
│  │   │   │  └───────────┘  │    └─────────────────┘    │  └───────────┘  │    └─────────────┘   │    │   │
│  │   │   └─────────────────┘                           └─────────────────┘                      │    │   │
│  │   │                                                                                             │    │   │
│  │   └────────────────────────────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                                                      │   │
│  │   ┌────────────────────────────────────────────────────────────────────────────────────────────┐    │   │
│  │   │                              Terraform IR Types                                             │    │   │
│  │   │                                                                                             │    │   │
│  │   │   ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐           │    │   │
│  │   │   │   TerraformBlock    │    │   TerraformValue    │    │   TerraformExpr     │           │    │   │
│  │   │   │  ┌───────────────┐  │    │  ┌───────────────┐  │    │  ┌───────────────┐  │           │    │   │
│  │   │   │  │ Kind: "resource"│ │    │  │ String *string│  │    │  │ Expression    │  │           │    │   │
│  │   │   │  │ Labels: [type, │  │    │  │ Number *float │  │    │  │ "aws_vpc.main │  │           │    │   │
│  │   │   │  │   name]        │  │    │  │ Bool *bool    │  │    │  │   .id"        │  │           │    │   │
│  │   │   │  │ Attributes: map│  │    │  │ List []Value  │  │    │  └───────────────┘  │           │    │   │
│  │   │   │  └───────────────┘  │    │  │ Map map[Value]│  │    └─────────────────────┘           │    │   │
│  │   │   └─────────────────────┘    │  │ Expr *Expr    │  │                                      │    │   │
│  │   │                              │  └───────────────┘  │                                      │    │   │
│  │   │                              └─────────────────────┘                                      │    │   │
│  │   └────────────────────────────────────────────────────────────────────────────────────────────┘    │   │
│  │                                                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                 │                                                           │
│                                                 ▼                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│  │                                    8. OUTPUT LAYER (File Generation)                                 │   │
│  ├─────────────────────────────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                                                      │   │
│  │   terraform_output/                                                                                  │   │
│  │   ├── main.tf          # Provider + all resources in topological order                              │   │
│  │   ├── variables.tf     # Input variables (placeholder if none)                                      │   │
│  │   └── outputs.tf       # Output values (placeholder if none)                                        │   │
│  │                                                                                                      │   │
│  │   Example main.tf:                                                                                   │   │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐   │   │
│  │   │  provider "aws" {                                                                            │   │   │
│  │   │    region = "us-east-1"                                                                      │   │   │
│  │   │  }                                                                                           │   │   │
│  │   │                                                                                              │   │   │
│  │   │  resource "aws_vpc" "vpc_2" {                                                                │   │   │
│  │   │    cidr_block           = "10.0.0.0/16"                                                      │   │   │
│  │   │    enable_dns_hostnames = true                                                               │   │   │
│  │   │    enable_dns_support   = true                                                               │   │   │
│  │   │    tags = { Name = "project-vpc" }                                                           │   │   │
│  │   │  }                                                                                           │   │   │
│  │   │                                                                                              │   │   │
│  │   │  resource "aws_subnet" "subnet_4" {                                                          │   │   │
│  │   │    vpc_id     = aws_vpc.vpc_2.id                                                             │   │   │
│  │   │    cidr_block = "10.0.144.0/24"                                                              │   │   │
│  │   │    ...                                                                                       │   │   │
│  │   │  }                                                                                           │   │   │
│  │   └─────────────────────────────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                                                      │   │
│  └──────────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                              │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

## Data Models

### 1. Input Layer - IR JSON Structures

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    IR JSON DATA MODELS                                       │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    IRDiagram                                         │   │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐    │   │
│   │  │  Nodes     []IRNode       // All diagram nodes                               │    │   │
│   │  │  Edges     []IREdge       // Relationships between nodes                     │    │   │
│   │  │  Variables []interface{}  // Frontend variables                              │    │   │
│   │  │  Timestamp int64          // Creation timestamp                              │    │   │
│   │  └─────────────────────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                               │
│                          ┌───────────────────┴───────────────────┐                          │
│                          ▼                                       ▼                          │
│   ┌──────────────────────────────────────┐   ┌──────────────────────────────────────┐      │
│   │              IRNode                   │   │              IREdge                   │      │
│   │  ┌────────────────────────────────┐  │   │  ┌────────────────────────────────┐  │      │
│   │  │  ID       string               │  │   │  │  ID     string                 │  │      │
│   │  │  Type     string               │  │   │  │  Source string                 │  │      │
│   │  │  Position *IRPosition          │  │   │  │  Target string                 │  │      │
│   │  │  ParentID *string              │  │   │  │  Type   *string                │  │      │
│   │  │  Data     IRNodeData           │  │   │  │  // "containment"              │  │      │
│   │  │  Style    map[string]interface │  │   │  │  // "dependency"               │  │      │
│   │  └────────────────────────────────┘  │   │  │  // "reference"                │  │      │
│   │              │                        │   │  └────────────────────────────────┘  │      │
│   │              ▼                        │   └──────────────────────────────────────┘      │
│   │  ┌────────────────────────────────┐  │                                                  │
│   │  │          IRNodeData            │  │                                                  │
│   │  │  ┌──────────────────────────┐  │  │                                                  │
│   │  │  │  Label        string     │  │  │                                                  │
│   │  │  │  ResourceType string     │  │  │                                                  │
│   │  │  │  Config       map[string]│  │  │                                                  │
│   │  │  │               interface{}│  │  │                                                  │
│   │  │  │  Status       string     │  │  │                                                  │
│   │  │  │  IsVisualOnly *bool      │  │  │                                                  │
│   │  │  └──────────────────────────┘  │  │                                                  │
│   │  └────────────────────────────────┘  │                                                  │
│   └──────────────────────────────────────┘                                                  │
│                                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 2. Diagram Layer - Graph Structures

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    DIAGRAM GRAPH DATA MODELS                                 │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                  DiagramGraph                                        │   │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐    │   │
│   │  │  Nodes map[string]*Node   // ID -> Node lookup                               │    │   │
│   │  │  Edges []*Edge            // All edges                                       │    │   │
│   │  │                                                                              │    │   │
│   │  │  Methods:                                                                    │    │   │
│   │  │  • GetNode(id) (*Node, bool)                                                 │    │   │
│   │  │  • GetChildren(parentID) []*Node                                             │    │   │
│   │  │  • GetParent(childID) (*Node, bool)                                          │    │   │
│   │  │  • GetContainmentEdges() []*Edge                                             │    │   │
│   │  │  • GetDependencyEdges() []*Edge                                              │    │   │
│   │  │  • BuildContainmentTree() map[string][]*Node                                 │    │   │
│   │  │  • GetRootNodes() []*Node                                                    │    │   │
│   │  │  • FindRegionNode() (*Node, bool)                                            │    │   │
│   │  └─────────────────────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                               │
│                          ┌───────────────────┴───────────────────┐                          │
│                          ▼                                       ▼                          │
│   ┌──────────────────────────────────────┐   ┌──────────────────────────────────────┐      │
│   │               Node                    │   │               Edge                    │      │
│   │  ┌────────────────────────────────┐  │   │  ┌────────────────────────────────┐  │      │
│   │  │  ID           string           │  │   │  │  ID     string                 │  │      │
│   │  │  Type         string           │  │   │  │  Source string                 │  │      │
│   │  │  ResourceType string           │  │   │  │  Target string                 │  │      │
│   │  │  Label        string           │  │   │  │  Type   string                 │  │      │
│   │  │  Config       map[string]any   │  │   │  │                                │  │      │
│   │  │  PositionX    int              │  │   │  │  Methods:                      │  │      │
│   │  │  PositionY    int              │  │   │  │  • IsContainment() bool        │  │      │
│   │  │  ParentID     *string          │  │   │  │  • IsDependency() bool         │  │      │
│   │  │  Status       string           │  │   │  │  • IsReference() bool          │  │      │
│   │  │  IsVisualOnly bool             │  │   │  └────────────────────────────────┘  │      │
│   │  │                                │  │   └──────────────────────────────────────┘      │
│   │  │  Methods:                      │  │                                                  │
│   │  │  • IsContainer() bool          │  │                                                  │
│   │  │  • IsResource() bool           │  │                                                  │
│   │  │  • IsRegion() bool             │  │                                                  │
│   │  └────────────────────────────────┘  │                                                  │
│   └──────────────────────────────────────┘                                                  │
│                                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3. Domain Layer - Architecture Aggregate

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    DOMAIN ARCHITECTURE DATA MODELS                           │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                   Architecture                                       │   │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐    │   │
│   │  │  Resources    []*Resource           // All resources in the architecture     │    │   │
│   │  │  Region       string                // Region configuration                  │    │   │
│   │  │  Provider     CloudProvider         // AWS, Azure, GCP                       │    │   │
│   │  │  Containments map[string][]string   // parentID -> []childIDs               │    │   │
│   │  │  Dependencies map[string][]string   // resourceID -> []dependencyIDs        │    │   │
│   │  │                                                                              │    │   │
│   │  │  Methods:                                                                    │    │   │
│   │  │  • Validate() error                                                          │    │   │
│   │  └─────────────────────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                               │
│                                              ▼                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    Resource                                          │   │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐    │   │
│   │  │  ID        string                   // Unique identifier                     │    │   │
│   │  │  Name      string                   // Resource name                         │    │   │
│   │  │  Type      ResourceType             // Type information                      │    │   │
│   │  │  Provider  CloudProvider            // Cloud provider                        │    │   │
│   │  │  Region    string                   // Region                                │    │   │
│   │  │  ParentID  *string                  // Parent resource ID                    │    │   │
│   │  │  DependsOn []string                 // Dependency IDs                        │    │   │
│   │  │  Metadata  map[string]interface{}   // Additional config/metadata            │    │   │
│   │  └─────────────────────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                               │
│                          ┌───────────────────┴───────────────────┐                          │
│                          ▼                                       ▼                          │
│   ┌──────────────────────────────────────┐   ┌──────────────────────────────────────┐      │
│   │           ResourceType                │   │          CloudProvider                │      │
│   │  ┌────────────────────────────────┐  │   │  ┌────────────────────────────────┐  │      │
│   │  │  ID         string             │  │   │  │  AWS   CloudProvider = "aws"   │  │      │
│   │  │  Name       string             │  │   │  │  Azure CloudProvider = "azure" │  │      │
│   │  │  Category   string             │  │   │  │  GCP   CloudProvider = "gcp"   │  │      │
│   │  │  Kind       string             │  │   │  └────────────────────────────────┘  │      │
│   │  │  IsRegional bool               │  │   └──────────────────────────────────────┘      │
│   │  │  IsGlobal   bool               │  │                                                  │
│   │  └────────────────────────────────┘  │                                                  │
│   └──────────────────────────────────────┘                                                  │
│                                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                      Graph                                           │   │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐    │   │
│   │  │  architecture *Architecture                                                  │    │   │
│   │  │                                                                              │    │   │
│   │  │  Methods:                                                                    │    │   │
│   │  │  • GetResource(id) (*Resource, bool)                                         │    │   │
│   │  │  • GetChildren(parentID) []*Resource                                         │    │   │
│   │  │  • GetParent(childID) (*Resource, bool)                                      │    │   │
│   │  │  • GetDependencies(resourceID) []*Resource                                   │    │   │
│   │  │  • GetRootResources() []*Resource                                            │    │   │
│   │  │  • BuildContainmentTree() map[string][]*Resource                             │    │   │
│   │  │  • TopologicalSort() (*TopologicalSortResult, error)                         │    │   │
│   │  │  • GetSortedResources() ([]*Resource, error)                                 │    │   │
│   │  └─────────────────────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                              TopologicalSortResult                                   │   │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐    │   │
│   │  │  Resources []*Resource   // Sorted in provisioning order                     │    │   │
│   │  │  Levels    [][]string    // Resources grouped by dependency level            │    │   │
│   │  │  HasCycle  bool          // True if cycle detected                           │    │   │
│   │  │  CycleInfo []string      // IDs involved in cycle                            │    │   │
│   │  └─────────────────────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 4. IaC Layer - Terraform Models

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    TERRAFORM IAC DATA MODELS                                 │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                  TerraformBlock                                      │   │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐    │   │
│   │  │  Kind       string                    // "resource", "provider", "data"...   │    │   │
│   │  │  Labels     []string                  // e.g. ["aws_vpc", "main"]            │    │   │
│   │  │  Attributes map[string]TerraformValue // Block attributes                    │    │   │
│   │  └─────────────────────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                               │
│                                              ▼                                               │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                 TerraformValue                                       │   │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐    │   │
│   │  │  String *string              // String value                                 │    │   │
│   │  │  Number *float64             // Numeric value                                │    │   │
│   │  │  Bool   *bool                // Boolean value                                │    │   │
│   │  │  List   []TerraformValue     // List of values                               │    │   │
│   │  │  Map    map[string]TerraformValue  // Map of values                          │    │   │
│   │  │  Expr   *TerraformExpr       // HCL expression (references)                  │    │   │
│   │  └─────────────────────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                               │
│                          ┌───────────────────┴───────────────────┐                          │
│                          ▼                                       ▼                          │
│   ┌──────────────────────────────────────┐   ┌──────────────────────────────────────┐      │
│   │          TerraformExpr                │   │            Reference                  │      │
│   │  ┌────────────────────────────────┐  │   │  ┌────────────────────────────────┐  │      │
│   │  │  string                        │  │   │  │  ResourceType string           │  │      │
│   │  │  // e.g. "aws_vpc.main.id"     │  │   │  │  ResourceName string           │  │      │
│   │  └────────────────────────────────┘  │   │  │  Attribute    string           │  │      │
│   └──────────────────────────────────────┘   │  │                                │  │      │
│                                              │  │  Method:                        │  │      │
│                                              │  │  • Expr() TerraformExpr         │  │      │
│                                              │  └────────────────────────────────┘  │      │
│                                              └──────────────────────────────────────┘      │
│                                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    iac.Output                                        │   │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐    │   │
│   │  │  Files []GeneratedFile                                                       │    │   │
│   │  └─────────────────────────────────────────────────────────────────────────────┘    │   │
│   │                                              │                                       │   │
│   │                                              ▼                                       │   │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐    │   │
│   │  │                              GeneratedFile                                   │    │   │
│   │  │  ┌───────────────────────────────────────────────────────────────────────┐  │    │   │
│   │  │  │  Path    string   // e.g. "main.tf"                                    │  │    │   │
│   │  │  │  Content string   // HCL content                                       │  │    │   │
│   │  │  │  Type    string   // "hcl"                                             │  │    │   │
│   │  │  └───────────────────────────────────────────────────────────────────────┘  │    │   │
│   │  └─────────────────────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

## Layer Interaction Sequence

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              LAYER INTERACTION SEQUENCE DIAGRAM                              │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐ │
│  │ UseCase │  │ Parser  │  │Validator│  │ Domain  │  │ AWS     │  │ Rules   │  │ TF Gen  │ │
│  │         │  │         │  │         │  │ Arch    │  │ Adapter │  │ Engine  │  │ Engine  │ │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘ │
│       │            │            │            │            │            │            │       │
│  ─────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼─────  │
│       │            │            │            │            │            │            │       │
│  1.   │ ReadJSON   │            │            │            │            │            │       │
│       │────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼───▶   │
│       │            │            │            │            │            │            │       │
│  2.   │ ParseIRDiagram()        │            │            │            │            │       │
│       │───────────▶│            │            │            │            │            │       │
│       │            │            │            │            │            │            │       │
│       │  IRDiagram │            │            │            │            │            │       │
│       │◀───────────│            │            │            │            │            │       │
│       │            │            │            │            │            │            │       │
│  3.   │ NormalizeToGraph()      │            │            │            │            │       │
│       │───────────▶│            │            │            │            │            │       │
│       │            │            │            │            │            │            │       │
│       │ DiagramGraph            │            │            │            │            │       │
│       │◀───────────│            │            │            │            │            │       │
│       │            │            │            │            │            │            │       │
│  4.   │ Validate(diagramGraph)  │            │            │            │            │       │
│       │────────────────────────▶│            │            │            │            │       │
│       │            │            │            │            │            │            │       │
│       │ ValidationResult        │            │            │            │            │       │
│       │◀────────────────────────│            │            │            │            │       │
│       │            │            │            │            │            │            │       │
│  5.   │ MapDiagramToArchitecture(graph, AWS) │            │            │            │       │
│       │─────────────────────────────────────▶│            │            │            │       │
│       │            │            │            │            │            │            │       │
│       │            │            │            │ GetGenerator(AWS)       │            │       │
│       │            │            │            │───────────▶│            │            │       │
│       │            │            │            │            │            │            │       │
│       │            │            │            │ AWSArchitectureGenerator│            │       │
│       │            │            │            │◀───────────│            │            │       │
│       │            │            │            │            │            │            │       │
│       │            │            │            │ Generate(diagramGraph)  │            │       │
│       │            │            │            │───────────▶│            │            │       │
│       │            │            │            │            │            │            │       │
│       │            │            │            │ MapIRTypeToResourceType │            │       │
│       │            │            │            │───────────▶│            │            │       │
│       │            │            │            │            │            │            │       │
│       │            │            │            │ ResourceType            │            │       │
│       │            │            │            │◀───────────│            │            │       │
│       │            │            │            │            │            │            │       │
│       │ Architecture             │            │            │            │            │       │
│       │◀─────────────────────────────────────│            │            │            │       │
│       │            │            │            │            │            │            │       │
│  6.   │ arch.Validate()          │            │            │            │            │       │
│       │─────────────────────────────────────▶│            │            │            │       │
│       │            │            │            │            │            │            │       │
│  7.   │ ValidateArchitecture(arch)           │            │            │            │       │
│       │──────────────────────────────────────────────────────────────▶│            │       │
│       │            │            │            │            │            │            │       │
│       │ map[string]*EvaluationResult         │            │            │            │       │
│       │◀──────────────────────────────────────────────────────────────│            │       │
│       │            │            │            │            │            │            │       │
│  8.   │ NewGraph(arch)           │            │            │            │            │       │
│       │─────────────────────────────────────▶│            │            │            │       │
│       │            │            │            │            │            │            │       │
│       │ Graph                    │            │            │            │            │       │
│       │◀─────────────────────────────────────│            │            │            │       │
│       │            │            │            │            │            │            │       │
│  9.   │ graph.GetSortedResources()           │            │            │            │       │
│       │─────────────────────────────────────▶│            │            │            │       │
│       │            │            │            │            │            │            │       │
│       │            │            │            │ TopologicalSort()       │            │       │
│       │            │            │            │ (Kahn's Algorithm)      │            │       │
│       │            │            │            │            │            │            │       │
│       │ []*Resource (sorted)     │            │            │            │            │       │
│       │◀─────────────────────────────────────│            │            │            │       │
│       │            │            │            │            │            │            │       │
│  10.  │ engine.Generate(arch, sortedResources)            │            │            │       │
│       │────────────────────────────────────────────────────────────────────────────▶│       │
│       │            │            │            │            │            │            │       │
│       │            │            │            │            │ mapper.MapResource()    │       │
│       │            │            │            │            │◀───────────────────────│       │
│       │            │            │            │            │            │            │       │
│       │            │            │            │            │ []TerraformBlock       │       │
│       │            │            │            │            │────────────────────────▶│       │
│       │            │            │            │            │            │            │       │
│       │            │            │            │            │            │ writer.    │       │
│       │            │            │            │            │            │ RenderMainTF()     │
│       │            │            │            │            │            │            │       │
│       │ iac.Output               │            │            │            │            │       │
│       │◀────────────────────────────────────────────────────────────────────────────│       │
│       │            │            │            │            │            │            │       │
│  11.  │ writeTerraformOutput()   │            │            │            │            │       │
│       │────────────────────────────────────────────────────────────────────────────────────▶│
│       │            │            │            │            │            │            │       │
│  ─────┼────────────┼────────────┼────────────┼────────────┼────────────┼────────────┼─────  │
│       │            │            │            │            │            │            │       │
│  ┌────┴────┐  ┌────┴────┐  ┌────┴────┐  ┌────┴────┐  ┌────┴────┐  ┌────┴────┐  ┌────┴────┐ │
│  │ UseCase │  │ Parser  │  │Validator│  │ Domain  │  │ AWS     │  │ Rules   │  │ TF Gen  │ │
│  │         │  │         │  │         │  │ Arch    │  │ Adapter │  │ Engine  │  │ Engine  │ │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘ │
│                                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

## Resource Type Mapping Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              RESOURCE TYPE MAPPING FLOW                                      │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│   Frontend IR Type          AWS Mapper              Domain ResourceType                      │
│   ────────────────          ──────────              ────────────────────                     │
│                                                                                              │
│   "region"         ────────▶ (skipped - project-level config)                               │
│                                                                                              │
│   "vpc"            ────────▶ "VPC"      ────────▶ ResourceType{                              │
│                                                     ID: "vpc",                               │
│                                                     Name: "VPC",                             │
│                                                     Category: "Networking",                  │
│                                                     Kind: "Network",                         │
│                                                     IsRegional: true                         │
│                                                   }                                          │
│                                                                                              │
│   "subnet"         ────────▶ "Subnet"   ────────▶ ResourceType{                              │
│                                                     ID: "subnet",                            │
│                                                     Name: "Subnet",                          │
│                                                     Category: "Networking",                  │
│                                                     Kind: "Network",                         │
│                                                     IsRegional: true                         │
│                                                   }                                          │
│                                                                                              │
│   "ec2"            ────────▶ "EC2"      ────────▶ ResourceType{                              │
│                                                     ID: "ec2",                               │
│                                                     Name: "EC2",                             │
│                                                     Category: "Compute",                     │
│                                                     Kind: "Instance",                        │
│                                                     IsRegional: true                         │
│                                                   }                                          │
│                                                                                              │
│   "security-group" ────────▶ "SecurityGroup" ───▶ ResourceType{                              │
│                                                     ID: "sg",                                │
│                                                     Name: "SecurityGroup",                   │
│                                                     Category: "Networking",                  │
│                                                     Kind: "Security",                        │
│                                                     IsRegional: true                         │
│                                                   }                                          │
│                                                                                              │
│   "route-table"    ────────▶ "RouteTable" ──────▶ ResourceType{...}                         │
│   "igw"            ────────▶ "InternetGateway" ─▶ ResourceType{...}                         │
│   "nat-gateway"    ────────▶ "NATGateway" ──────▶ ResourceType{...}                         │
│   "s3"             ────────▶ "S3" ──────────────▶ ResourceType{...}                         │
│                                                                                              │
│   "docker"         ────────▶ (skipped - isVisualOnly: true)                                 │
│                                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

## Terraform Block Generation Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              TERRAFORM BLOCK GENERATION FLOW                                 │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│   Domain Resource                  AWS Mapper                    TerraformBlock              │
│   ───────────────                  ──────────                    ──────────────              │
│                                                                                              │
│   Resource{                                                                                  │
│     ID: "vpc-2",                                                                             │
│     Name: "project-vpc",                                                                     │
│     Type: {Name: "VPC"},    ────▶  mapVPC()      ────────────▶  TerraformBlock{              │
│     Metadata: {                                                   Kind: "resource",          │
│       cidr: "10.0.0.0/16",                                        Labels: ["aws_vpc",        │
│       enableDnsHostnames: true                                             "vpc_2"],         │
│     }                                                             Attributes: {              │
│   }                                                                 cidr_block: "10.0.0.0/16"│
│                                                                     enable_dns_hostnames:    │
│                                                                       true,                  │
│                                                                     tags: {Name: "..."}      │
│                                                                   }                          │
│                                                                 }                            │
│                                                                                              │
│   Resource{                                                                                  │
│     ID: "subnet-4",                                                                          │
│     Name: "public",                                                                          │
│     Type: {Name: "Subnet"}, ────▶  mapSubnet()   ────────────▶  TerraformBlock{              │
│     ParentID: "vpc-2",                                            Kind: "resource",          │
│     Metadata: {                                                   Labels: ["aws_subnet",     │
│       cidr: "10.0.144.0/24"                                                "subnet_4"],      │
│     }                                                             Attributes: {              │
│   }                                                                 vpc_id: aws_vpc.vpc_2.id │
│                                                                     cidr_block: "10.0.144..."│
│                                                                   }                          │
│                                                                 }                            │
│                                                                                              │
│   Resource{                                                                                  │
│     ID: "ec2-7",                                                                             │
│     Name: "web-server",                                                                      │
│     Type: {Name: "EC2"},    ────▶  mapEC2()      ────────────▶  TerraformBlock{              │
│     ParentID: "subnet-6",                                         Kind: "resource",          │
│     Metadata: {                                                   Labels: ["aws_instance",   │
│       ami: "ami-0123...",                                                  "ec2_7"],         │
│       instanceType: "t3.micro",                                   Attributes: {              │
│       securityGroups: [...]                                         ami: "ami-0123...",      │
│     }                                                               instance_type: "t3.micro"│
│   }                                                                 subnet_id: aws_subnet.   │
│                                                                               subnet_6.id,   │
│                                                                     vpc_security_group_ids:  │
│                                                                       [aws_security_group.   │
│                                                                        sg_1.id]              │
│                                                                   }                          │
│                                                                 }                            │
│                                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

## Topological Sort Example

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              TOPOLOGICAL SORT EXAMPLE                                        │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│   Input Architecture (from JSON):                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                      │   │
│   │   region-1 (skipped - project config)                                               │   │
│   │       │                                                                              │   │
│   │       └──▶ vpc-2                                                                     │   │
│   │               │                                                                      │   │
│   │               ├──▶ security-group-1                                                  │   │
│   │               │                                                                      │   │
│   │               ├──▶ route-table-3 (main)                                              │   │
│   │               │                                                                      │   │
│   │               ├──▶ subnet-4                                                          │   │
│   │               │       │                                                              │   │
│   │               │       └──▶ nat-gateway-5                                             │   │
│   │               │                                                                      │   │
│   │               ├──▶ subnet-6                                                          │   │
│   │               │       │                                                              │   │
│   │               │       ├──▶ ec2-7                                                     │   │
│   │               │       │                                                              │   │
│   │               │       └──▶ docker-1 (skipped - isVisualOnly)                         │   │
│   │               │                                                                      │   │
│   │               ├──▶ route-table-8                                                     │   │
│   │               │                                                                      │   │
│   │               ├──▶ igw-9                                                             │   │
│   │               │                                                                      │   │
│   │               └──▶ route-table-10                                                    │   │
│   │                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                              │
│   Dependency Graph (for topological sort):                                                   │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                      │   │
│   │                              vpc-2                                                   │   │
│   │                                │                                                     │   │
│   │         ┌──────────┬───────────┼───────────┬──────────┬──────────┐                  │   │
│   │         ▼          ▼           ▼           ▼          ▼          ▼                  │   │
│   │   security-  route-table-3  subnet-4   subnet-6   igw-9   route-table-8             │   │
│   │   group-1                      │           │                 │                      │   │
│   │                                ▼           │                 │                      │   │
│   │                          nat-gateway-5     │                 │                      │   │
│   │                                            ▼                 │                      │   │
│   │                                          ec2-7               │                      │   │
│   │                                                              ▼                      │   │
│   │                                                        route-table-10               │   │
│   │                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                              │
│   Sorted Output (Kahn's Algorithm):                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                      │   │
│   │   Level 0: [vpc-2]                    // No dependencies                            │   │
│   │   Level 1: [security-group-1, route-table-3, subnet-4, subnet-6,                    │   │
│   │             igw-9, route-table-8]     // Depend on VPC                              │   │
│   │   Level 2: [nat-gateway-5, ec2-7, route-table-10]  // Depend on subnets/etc.       │   │
│   │                                                                                      │   │
│   │   Final Order: vpc-2 → security-group-1 → route-table-3 → subnet-4 →               │   │
│   │                subnet-6 → igw-9 → route-table-8 → nat-gateway-5 →                   │   │
│   │                ec2-7 → route-table-10                                               │   │
│   │                                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

## Registry Pattern

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                              REGISTRY PATTERN FOR EXTENSIBILITY                              │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                         Architecture Generator Registry                              │   │
│   │                                                                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  Domain Layer                                                                │   │   │
│   │   │  ┌─────────────────────────────────────────────────────────────────────┐    │   │   │
│   │   │  │  interface ArchitectureGenerator {                                   │    │   │   │
│   │   │  │    Provider() CloudProvider                                          │    │   │   │
│   │   │  │    Generate(*DiagramGraph) (*Architecture, error)                    │    │   │   │
│   │   │  │  }                                                                   │    │   │   │
│   │   │  │                                                                      │    │   │   │
│   │   │  │  generators map[CloudProvider]ArchitectureGenerator                  │    │   │   │
│   │   │  │                                                                      │    │   │   │
│   │   │  │  RegisterGenerator(g ArchitectureGenerator)                          │    │   │   │
│   │   │  │  GetGenerator(provider) (ArchitectureGenerator, bool)                │    │   │   │
│   │   │  └─────────────────────────────────────────────────────────────────────┘    │   │   │
│   │   └──────────────────────────────────────────────────────────────────────────────┘   │   │
│   │                                              ▲                                       │   │
│   │                                              │                                       │   │
│   │   ┌──────────────────────────────────────────┼──────────────────────────────────┐   │   │
│   │   │  Cloud Adapter Layer                     │                                   │   │   │
│   │   │                                          │                                   │   │   │
│   │   │   ┌──────────────────┐    ┌──────────────┴───────────┐    ┌──────────────┐  │   │   │
│   │   │   │ AWSArchitecture  │    │  init() {                │    │ (Future)     │  │   │   │
│   │   │   │   Generator      │───▶│    RegisterGenerator(    │    │ Azure/GCP    │  │   │   │
│   │   │   │                  │    │      NewAWSGenerator())  │    │ Generators   │  │   │   │
│   │   │   └──────────────────┘    │  }                       │    └──────────────┘  │   │   │
│   │   │                           └──────────────────────────┘                       │   │   │
│   │   └──────────────────────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                         Terraform Mapper Registry                                    │   │
│   │                                                                                      │   │
│   │   ┌─────────────────────────────────────────────────────────────────────────────┐   │   │
│   │   │  IaC Layer                                                                   │   │   │
│   │   │  ┌─────────────────────────────────────────────────────────────────────┐    │   │   │
│   │   │  │  interface ResourceMapper {                                          │    │   │   │
│   │   │  │    Provider() string                                                 │    │   │   │
│   │   │  │    SupportsResource(resourceType string) bool                        │    │   │   │
│   │   │  │    MapResource(*Resource) ([]TerraformBlock, error)                  │    │   │   │
│   │   │  │  }                                                                   │    │   │   │
│   │   │  │                                                                      │    │   │   │
│   │   │  │  MapperRegistry {                                                    │    │   │   │
│   │   │  │    mappers map[string]ResourceMapper                                 │    │   │   │
│   │   │  │    Register(m ResourceMapper)                                        │    │   │   │
│   │   │  │    Get(provider string) (ResourceMapper, bool)                       │    │   │   │
│   │   │  │  }                                                                   │    │   │   │
│   │   │  └─────────────────────────────────────────────────────────────────────┘    │   │   │
│   │   └──────────────────────────────────────────────────────────────────────────────┘   │   │
│   │                                              ▲                                       │   │
│   │                                              │                                       │   │
│   │   ┌──────────────────────────────────────────┼──────────────────────────────────┐   │   │
│   │   │  Cloud Adapter Layer                     │                                   │   │   │
│   │   │                                          │                                   │   │   │
│   │   │   ┌──────────────────┐    ┌──────────────┴───────────┐    ┌──────────────┐  │   │   │
│   │   │   │    AWSMapper     │    │  mapperRegistry.Register │    │ (Future)     │  │   │   │
│   │   │   │   mapVPC()       │───▶│    (terraform.New())     │    │ Azure/GCP    │  │   │   │
│   │   │   │   mapSubnet()    │    │                          │    │ Mappers      │  │   │   │
│   │   │   │   mapEC2()       │    └──────────────────────────┘    └──────────────┘  │   │   │
│   │   │   │   mapSG()        │                                                       │   │   │
│   │   │   └──────────────────┘                                                       │   │   │
│   │   └──────────────────────────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

## Key Design Principles

1. **Layer Separation**: Each layer has a single responsibility
   - Diagram Layer: Parse and validate visual representation
   - Domain Layer: Cloud-agnostic business logic
   - Cloud Adapter Layer: Provider-specific implementations
   - IaC Layer: Code generation

2. **Registry Pattern**: Extensibility through registration
   - New cloud providers can be added by implementing interfaces
   - Auto-registration via `init()` functions

3. **Two-Pass Processing**: Reliable relationship resolution
   - First pass: Build ID mappings
   - Second pass: Create resources with resolved references

4. **Topological Sorting**: Safe provisioning order
   - Dependencies are resolved before dependents
   - Cycle detection prevents invalid configurations

5. **Expression-Based References**: Proper Terraform output
   - References like `aws_vpc.main.id` are expressions, not strings
   - HCL writer handles proper rendering

## File Structure

```
backend/
├── pkg/usecases/scenario5_terraform_codegen/
│   └── terraform_codegen.go          # Main orchestration
│
├── internal/diagram/
│   ├── parser/
│   │   └── canvas_parser.go          # IR JSON parsing
│   ├── validator/
│   │   └── validator.go              # Diagram validation
│   └── graph/
│       ├── graph.go                  # DiagramGraph
│       ├── node.go                   # Node model
│       └── edge.go                   # Edge model
│
├── internal/domain/
│   ├── architecture/
│   │   ├── aggregate.go              # Architecture aggregate
│   │   ├── graph.go                  # Graph wrapper
│   │   ├── toposort.go               # Topological sorting
│   │   ├── generator.go              # Generator interface
│   │   └── resource_type_mapper.go   # Mapper interface
│   ├── resource/
│   │   └── resource.go               # Resource model
│   └── rules/
│       └── engine/                   # Rules evaluation
│
├── internal/cloud/aws/
│   ├── architecture/
│   │   ├── generator.go              # AWS generator
│   │   ├── resource_type_mapper.go   # AWS type mapper
│   │   └── registry.go               # Auto-registration
│   ├── mapper/terraform/
│   │   └── mapper.go                 # AWS Terraform mapper
│   └── rules/
│       └── service.go                # AWS rules
│
└── internal/iac/
    ├── engine.go                     # Engine interface
    └── terraform/
        ├── generator/
        │   └── generator.go          # Terraform engine
        ├── mapper/
        │   └── types.go              # TerraformBlock, etc.
        └── writer/
            └── writer.go             # HCL rendering
```
